<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>曜日天梯榜 - SOLAR CUP</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* =========================================
           EVA THEME & CORE STYLES
           ========================================= */
        :root {
            --eva-dark-bg: #0b0b0e;
            --eva-purple: #9d5df2;
            --eva-green: #39ff14;
            --eva-orange: #ff9900;
            --color-platinum: #00bfff;
            --color-gold: #ffd700;
            --color-silver: #ff0f4f;
            --color-bronze: #39ff14;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html { scroll-behavior: smooth; }

        body {
            background-color: var(--eva-dark-bg);
            color: #fff;
            font-family: 'Helvetica Neue', Arial, 'Hiragino Sans', 'Meiryo', '微軟正黑體', sans-serif;
            margin: 0; padding: 0;
            background-image: 
                radial-gradient(circle at center, transparent 0%, #000 90%),
                linear-gradient(0deg, rgba(157, 93, 242, 0.05) 1px, transparent 1px), 
                linear-gradient(90deg, rgba(157, 93, 242, 0.05) 1px, transparent 1px);
            background-size: 100% 100%, 40px 40px, 40px 40px;
            min-height: 100vh;
            font-size: 16px; 
            display: flex; flex-direction: column;
        }

        /* === Loading Overlay === */
        #loadingOverlay {
            display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 9999;
            align-items: center; justify-content: center; flex-direction: column;
        }
        .loader-text {
            color: var(--eva-orange); font-family: 'Impact'; font-size: 2rem; letter-spacing: 2px;
            animation: blink 0.5s infinite alternate; text-align: center;
        }
        .loader-sub { color: #666; font-size: 0.8rem; margin-top:10px; letter-spacing: 1px; }
        @keyframes blink { from { opacity: 1; } to { opacity: 0.3; } }

        /* === Sticky Header === */
        .sticky-controls {
            position: sticky; top: 0; z-index: 1000;
            background: rgba(11, 11, 14, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 2px solid var(--eva-purple);
            box-shadow: 0 5px 20px rgba(0,0,0,0.8);
            padding-bottom: 10px;
        }

        .title-card {
            font-family: "MS Mincho", "SimSun", serif;
            font-weight: 900; text-align: center; 
            font-size: 2.2rem; letter-spacing: 0.1em; color: #fff; padding-top: 15px;
            text-shadow: 0 0 10px var(--eva-purple); line-height: 1.2;
        }
        .sub-title {
            text-align: center; font-size: 0.75rem; color: var(--eva-green); 
            letter-spacing: 3px; margin-bottom: 10px; opacity: 0.8; font-weight: bold;
        }

        /* Filter Buttons */
        .filter-container { width: 100%; overflow-x: auto; padding: 0 10px; -webkit-overflow-scrolling: touch; }
        .filter-group { display: flex; justify-content: center; gap: 8px; margin: 5px 0; white-space: nowrap; min-width: max-content; }
        @media (max-width: 600px) {
            .filter-group { justify-content: flex-start; }
            .filter-container::-webkit-scrollbar { display: none; } 
            .title-card { font-size: 1.8rem; padding-top: 10px; }
        }

        .filter-btn {
            background: rgba(0,0,0,0.6); border: 1px solid #444;
            color: #aaa; padding: 8px 16px; cursor: pointer;
            font-size: 0.85rem; letter-spacing: 1px; transition: all 0.2s;
            text-transform: uppercase; border-radius: 4px; flex-shrink: 0;
        }
        .filter-btn.active { color: #000; font-weight: bold; border: none; transform: scale(1.05); }
        .btn-all.active { background: #fff; box-shadow: 0 0 10px #fff; }
        .btn-plat.active { background: var(--color-platinum); box-shadow: 0 0 10px var(--color-platinum); }
        .btn-gold.active { background: var(--color-gold); box-shadow: 0 0 10px var(--color-gold); }
        .btn-silver.active { background: var(--color-silver); box-shadow: 0 0 10px var(--color-silver); }
        .btn-bronze.active { background: var(--color-bronze); box-shadow: 0 0 10px var(--color-bronze); }

        .search-box { display: flex; justify-content: center; padding: 5px 15px; margin-top: 5px;}
        #searchInput {
            background: rgba(0,0,0,0.5); border: 1px solid var(--eva-purple);
            color: #fff; padding: 12px; width: 100%; max-width: 500px;
            text-align: center; font-size: 1rem; border-radius: 4px;
        }

        /* === Table System === */
        .ladder-wrapper { max-width: 1200px; margin: 0 auto; padding-bottom: 20px; flex-grow: 1; width: 100%;}
        .system-bar {
            background: linear-gradient(90deg, var(--eva-purple), transparent);
            color: #fff; padding: 5px 15px; font-size: 0.75rem;
            letter-spacing: 2px; margin-top: 10px; font-weight: bold;
        }

        table { width: 100%; border-collapse: separate; border-spacing: 0 6px; }
        thead th {
            background: #151515; color: #888; padding: 12px;
            border-bottom: 2px solid var(--eva-purple);
            font-size: 0.85rem; letter-spacing: 1px; text-transform: uppercase;
        }
        th.th-total { color: var(--eva-green); border-bottom: 2px solid var(--eva-green); }

        tr { position: relative; }
        td {
            padding: 12px; text-align: center;
            background: rgba(30,30,35,0.7);
            border: 1px solid transparent;
            font-size: 1rem; color: #ddd; vertical-align: middle; cursor: pointer;
        }

        /* List View */
        tbody.list-view td:first-child {
            position: relative;
            background-image: linear-gradient(30deg, #000 12%, transparent 12.5%, transparent 87%, #000 87.5%, #000), linear-gradient(150deg, #000 12%, transparent 12.5%, transparent 87%, #000 87.5%, #000), linear-gradient(60deg, rgba(255,255,255,0.05) 25%, transparent 25.5%, transparent 75%, rgba(255,255,255,0.05) 75%, rgba(255,255,255,0.05));
            background-size: 20px 35px; box-shadow: inset 4px 0 0 0 currentColor;
        }
        
        .rank-num { font-family: 'Impact', sans-serif; font-size: 1.5rem; font-style: italic; }
        .pilot-name { font-weight: bold; color: #fff; font-size: 1.1rem; }
        /* Player ID Style */
        .pilot-id { display: block; font-size: 0.65rem; color: #666; font-weight: normal; letter-spacing: 1px; margin-top: 2px;}
        
        .total-score { font-weight: bold; color: var(--eva-green); font-size: 1.2rem; font-family: 'Impact', sans-serif; }
        
        .text-platinum { color: var(--color-platinum); }
        .text-gold { color: var(--color-gold); }
        .text-silver { color: var(--color-silver); }
        .text-bronze { color: var(--color-bronze); }

        tbody.list-view tr:hover td { background: rgba(255,255,255,0.15); }

        @media (max-width: 768px) {
            tbody.list-view td:nth-child(4), tbody.list-view th:nth-child(4) { display: none; }
            tbody.list-view td { padding: 10px 5px; }
            table { min-width: 100%; }
        }

        /* === Card View === */
        tbody.card-view { display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; padding: 10px; }
        tbody.card-view tr {
            display: flex; flex-wrap: wrap; width: 100%; max-width: 450px;
            margin: 0; padding: 0; background: rgba(25,25,30,0.9);
            box-shadow: 0 4px 15px rgba(0,0,0,0.6); border-radius: 6px; overflow: hidden;
            border: 1px solid #333; transition: transform 0.1s;
        }
        tbody.card-view tr:active { transform: scale(0.98); }

        tbody.card-view td:nth-of-type(1) { 
            width: 20%; font-size: 2.2rem; text-align: center; 
            display: flex; align-items: center; justify-content: center;
            background-image: linear-gradient(30deg, #000 12%, transparent 12.5%, transparent 87%, #000 87.5%, #000), linear-gradient(60deg, rgba(255,255,255,0.05) 25%, transparent 25.5%, transparent 75%, rgba(255,255,255,0.05) 75%, rgba(255,255,255,0.05));
            background-size: 20px 35px; box-shadow: inset 6px 0 0 0 currentColor; padding: 20px 0;
        }
        tbody.card-view td:nth-of-type(2) { 
            width: 75%; font-size: 1.4rem; border-bottom: 1px solid #444 !important; 
            margin: 10px 0 5px 5px; background: none !important; text-align: left; padding-left: 10px;
        }
        tbody.card-view td:nth-of-type(3) { 
            width: 100%; margin: 0; padding: 5px 15px; display: flex; justify-content: space-between; align-items: center;
            background: rgba(0,0,0,0.3) !important; border-bottom: 1px dashed #444 !important;
        }
        tbody.card-view td:nth-of-type(3)::before { content: "TOTAL SYNC"; font-size: 0.8rem; color: #888; }
        tbody.card-view td:nth-of-type(4) { display: none; }
        tbody.card-view tr::after {
            content: "TAP FOR BATTLE LOG >>"; display: block; width: 100%; text-align: right;
            font-size: 0.7rem; color: #555; padding: 5px 15px; letter-spacing: 1px;
        }
        .hide-header thead { display: none; }

        /* === Modal === */
        .modal {
            display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.9); backdrop-filter: blur(8px); align-items: center; justify-content: center; padding: 15px;
        }
        .modal-content {
            background: #15151a; border: 2px solid var(--eva-purple); width: 100%; max-width: 420px; 
            max-height: 90vh; display: flex; flex-direction: column;
            padding: 25px; position: relative;
            box-shadow: 0 0 40px var(--eva-purple); border-radius: 8px; animation: modalPop 0.3s;
        }
        @keyframes modalPop { 0% { transform: scale(0.9); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        .close-modal { position: absolute; top: 10px; right: 15px; color: #888; font-size: 36px; cursor: pointer; padding: 10px; z-index: 10; }
        
        .pilot-header { display: flex; align-items: center; margin-bottom: 15px; border-bottom: 1px solid #333; padding-bottom: 15px; flex-shrink: 0; }
        .p-rank { font-size: 4rem; font-family: 'Impact'; margin-right: 15px; line-height: 1; color: #fff; }
        .p-name { font-size: 1.8rem; font-weight: bold; color: #fff; display: block; line-height: 1.2;}
        .p-id-modal { font-size: 0.9rem; color: #666; font-family: monospace; display: block; margin-top: 3px; letter-spacing: 1px;}

        .battle-log-container {
            background: #08080a; border: 1px solid #333; border-radius: 4px; margin-bottom: 15px;
            flex-grow: 1; overflow-y: auto; max-height: 250px; padding: 10px;
            scrollbar-width: thin; scrollbar-color: var(--eva-purple) #000;
        }
        .battle-log-container::-webkit-scrollbar { width: 6px; }
        .battle-log-container::-webkit-scrollbar-track { background: #000; }
        .battle-log-container::-webkit-scrollbar-thumb { background: var(--eva-purple); border-radius: 3px; }

        .log-title { font-size: 0.8rem; color: #888; border-bottom: 1px solid #444; margin-bottom: 10px; padding-bottom: 5px; letter-spacing: 2px; position: sticky; top:0; background: #08080a; }
        .log-row { display: flex; justify-content: space-between; margin-bottom: 12px; font-size: 0.95rem; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 5px;}
        .log-cup { color: var(--eva-purple); font-weight: bold; font-size: 0.85rem; font-family: 'Arial Black', sans-serif; letter-spacing: 0.5px;}
        
        .eva-quote-box {
            padding: 15px; background: rgba(255, 153, 0, 0.05); border-left: 4px solid var(--eva-orange);
            text-align: center; margin-bottom: 10px; flex-shrink: 0; position: relative;
        }
        .quote-cn { display: block; font-size: 1.25rem; color: #fff; font-weight: bold; margin-bottom: 8px; font-style: normal; text-shadow: 0 0 5px rgba(0,0,0,0.5); }
        .quote-jp { display: block; font-size: 0.85rem; color: #888; font-family: "MS Mincho", serif; margin-bottom: 10px; letter-spacing: 1px; }
        .quote-source { display: block; text-align: right; font-size: 0.75rem; color: var(--eva-orange); font-weight: bold; margin-top: 5px; }
        .quote-label { display: block; font-size: 0.6rem; color: #666; text-align: left; margin-bottom: 5px; letter-spacing: 2px; }

        .bottom-admin-panel {
            text-align: center; padding: 20px 0 40px 0; margin-top: auto;
            border-top: 1px solid #222; background: rgba(0,0,0,0.5);
        }
        .footer-deco { text-align: center; font-size: 0.7rem; color: #555; padding: 10px; line-height: 1.5; }
    </style>
</head>
<body>

    <div id="loadingOverlay">
        <div class="loader-text">MAGI SYSTEM PROCESSING...</div>
        <div class="loader-sub">CONNECTING TO SOLAR DATABASE...</div>
    </div>

    <div id="playerModal" class="modal">
        <div class="modal-content" id="modalCard">
            <span class="close-modal" onclick="closeModal()">&times;</span>
            
            <div class="pilot-header">
                <div id="mRank" class="p-rank">01</div>
                <div class="p-info">
                    <span id="mName" class="p-name">NAME</span>
                    <span id="mId" class="p-id-modal">ID: P-001</span>
                    <span style="font-size: 0.8rem; color: var(--eva-green); letter-spacing: 1px;">TOTAL SYNC: <span id="mScore" style="color:#fff; font-size:1.4rem; font-weight:bold;">400</span></span>
                </div>
            </div>

            <div class="battle-log-container">
                <div class="log-title">BATTLE LOG (歷史戰績)</div>
                <div id="mHistoryList"></div>
            </div>

            <div class="eva-quote-box">
                <span class="quote-label">VOICE DATA RECORDING</span>
                <span id="mQuoteCN" class="quote-cn">"不能逃避。"</span>
                <span id="mQuoteJP" class="quote-jp">逃げちゃダメだ。</span>
                <span id="mQuoteSource" class="quote-source">—— 碇シンジ</span>
            </div>
            
            <div style="margin-top: 10px; font-size: 0.7rem; color: #444; text-align: right;">NERV PERSONNEL FILE: CLASSIFIED</div>
        </div>
    </div>

    <div class="sticky-controls">
        <div class="title-card">曜日天梯榜</div>
        <div class="sub-title">SOLAR CUP BADMINTON LEAGUE</div>
        
        <div class="filter-container">
            <div class="filter-group">
                <button class="filter-btn btn-all active" onclick="filterTier('all')">ALL (總覽)</button>
                <button class="filter-btn btn-plat" onclick="filterTier('platinum')">白金 (分組)</button>
                <button class="filter-btn btn-gold" onclick="filterTier('gold')">黃金 (分組)</button>
                <button class="filter-btn btn-silver" onclick="filterTier('silver')">白銀 (分組)</button>
                <button class="filter-btn btn-bronze" onclick="filterTier('bronze')">青銅 (分組)</button>
            </div>
        </div>

        <div class="search-box">
            <input type="text" id="searchInput" onkeyup="searchPilot()" placeholder="輸入選手名稱或編號搜尋 (SEARCH)...">
        </div>
    </div>

    <div class="ladder-wrapper">
        <div class="system-bar" id="systemStatus">WAITING FOR DATA SYNCHRONIZATION...</div>
        
        <table id="ladderTable">
            <thead>
                <tr>
                    <th width="15%">RANK</th>
                    <th width="35%">PILOT</th>
                    <th width="25%" class="th-total">TOTAL SYNC</th>
                    <th width="25%">LATEST CUP</th>
                </tr>
            </thead>
            <tbody id="tableBody" class="list-view">
                <tr>
                    <td colspan="4" style="padding: 50px; color: #666; font-style: italic;">
                        WAITING FOR MAGI CONNECTION...
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="bottom-admin-panel">
        <div class="footer-deco">NERV TOKYO-3 // MAGI SYSTEM VER 22.0 // ID SYSTEM ONLINE</div>
    </div>

    <script>
        // =========================================================
        // ⚠️⚠️⚠️ 關鍵設定：請更新您的 Google Sheet CSV 連結 ⚠️⚠️⚠️
        const GOOGLE_SHEET_CSV_URL = "請將您的_GOOGLE_SHEET_CSV_連結貼在這裡"; 
        // =========================================================

        const tableBody = document.getElementById("tableBody");
        const systemStatus = document.getElementById("systemStatus");
        
        const evaQuotes = [
            { jp: "逃げちゃダメだ。逃げちゃダメだ。", cn: "不能逃避。不能逃避。", source: "碇シンジ" },
            { jp: "笑えばいいと思うよ。", cn: "我認為你只要微笑就好了。", source: "碇シンジ" },
            { jp: "あなたは死なないわ、私が守るもの。", cn: "你不會死的，我會保護你。", source: "綾波レイ" },
            { jp: "あんたバカぁ？", cn: "你是笨蛋嗎？", source: "式波・アスカ・ラングレー" },
            { jp: "奇跡を待つより、捨て身の努力よ！", cn: "與其等待奇蹟，不如拚死努力！", source: "葛城ミサト" },
            { jp: "大人のキスよ。帰ってきたら続きをしましょう。", cn: "這是大人的吻喔。等回來之後再繼續吧。", source: "葛城ミサト" },
            { jp: "生きてさえいれば、どこだって天国になるわ。", cn: "只要活著，哪裡都能成為天堂。", source: "ユイ / ゲンドウ" },
            { jp: "歌はいいね。歌は心を潤してくれる。", cn: "歌真好啊。歌能以此潤澤心靈。", source: "渚カヲル" },
            { jp: "君に会うために生まれてきたのかもしれない。", cn: "我也許就是為了與你相遇才出生的。", source: "渚カヲル" },
            { jp: "時計の針は元には戻らない。だが、自らの手で進めることはできる。", cn: "時鐘的指針無法倒轉。但可以用自己的手去推進。", source: "碇ゲンドウ" },
            { jp: "自分には、自分以外の人間との間にある壁、心の壁がある。", cn: "人與人之間有著隔閡，那是心之壁。", source: "渚カヲル" },
            { jp: "さようなら、全てのエヴァンゲリオン。", cn: "再見了，所有的福音戰士。", source: "真希波" }
        ];

        const cupNames = ["ONE", "TWO", "THREE", "FOUR", "FIVE", "SIX", "SEVEN", "EIGHT", "NINE", "TEN", "ELEVEN", "TWELVE"];
        function getCupName(index) {
            return cupNames[index] || `NO.${index + 1}`;
        }

        window.onload = function() {
            if(GOOGLE_SHEET_CSV_URL.includes("https://docs.google.com/spreadsheets/d/e/2PACX-1vT40Ezc3eu9HtyGZL5bFHuNudksoBz7gVGXycPyGD22vZB2MxO7mCSXVTz-roAUpckS1pZy3dBE9jTy/pub?gid=2080286926&single=true&output=csv")) {
                alert("請記得編輯 HTML 檔案，貼上您的 Google Sheet CSV 連結！");
                document.getElementById('loadingOverlay').style.display = 'none';
                return;
            }
            fetchGoogleSheetData();
        };

        function fetchGoogleSheetData() {
            const urlWithCacheBust = GOOGLE_SHEET_CSV_URL + "&t=" + Date.now();
            fetch(urlWithCacheBust)
                .then(response => {
                    if (!response.ok) throw new Error("Network response was not ok");
                    return response.arrayBuffer();
                })
                .then(data => {
                    const workbook = XLSX.read(data, {type: 'array'});
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, {header: 1});
                    
                    if(jsonData.length > 1) {
                        processData(jsonData.slice(1));
                    } else {
                        throw new Error("No data found in sheet");
                    }
                })
                .catch(error => {
                    console.error("Error fetching data:", error);
                    systemStatus.innerText = "CONNECTION FAILED // PLEASE CHECK URL";
                    document.getElementById('loadingOverlay').style.display = 'none';
                });
        }

        function processData(rawData) {
            // Updated Schema: A=ID, B=Name, C=Tier, D=Score, E...=Cups
            // row[0]=ID, row[1]=Name, row[2]=Tier, row[3]=Score, row[4...]=History
            let pilots = rawData.map(row => {
                if (!row || row.length === 0) return null;
                
                let history = [];
                // History starts from Column E (Index 4)
                if (row.length > 4) {
                    for(let i = 4; i < row.length; i++) {
                        if(row[i] !== undefined && row[i] !== null && row[i].toString().trim() !== "") {
                            history.push(row[i]);
                        }
                    }
                }

                return {
                    id: row[0] || "UNK",
                    name: row[1] || "UNKNOWN",
                    tier: row[2] || "青銅級", 
                    score: typeof row[3] === 'number' ? row[3] : parseInt(row[3]) || 0,
                    history: history 
                };
            }).filter(item => item !== null && item.name !== "UNKNOWN");

            pilots.sort((a, b) => b.score - a.score);
            renderTable(pilots);
            
            document.getElementById('loadingOverlay').style.display = 'none';
            systemStatus.innerText = `SYNC COMPLETE // ${pilots.length} PILOTS LOADED`;
        }

        function renderTable(pilots) {
            tableBody.innerHTML = "";
            pilots.forEach((p, index) => {
                const tr = document.createElement('tr');
                const rank = index + 1;
                
                let tierClass = "bronze";
                let textClass = "text-bronze";
                const tierStr = p.tier ? p.tier.toString() : "";
                if (tierStr.indexOf("白金") > -1) { tierClass = "platinum"; textClass = "text-platinum"; }
                else if (tierStr.indexOf("黃金") > -1) { tierClass = "gold"; textClass = "text-gold"; }
                else if (tierStr.indexOf("白銀") > -1) { tierClass = "silver"; textClass = "text-silver"; }

                tr.className = `row-${tierClass}`;
                tr.setAttribute('data-tier', tierClass);
                
                tr.dataset.pilotData = JSON.stringify({
                    rank: rank < 10 ? `0${rank}` : rank,
                    id: p.id,
                    name: p.name,
                    score: p.score,
                    history: p.history,
                    tierClass: tierClass
                });
                
                tr.onclick = function() { openCard(this); };

                let lastResult = (p.history && p.history.length > 0) ? p.history[0] : "-";

                tr.innerHTML = `
                    <td class="rank-num ${textClass}">${rank < 10 ? `0${rank}` : rank}</td>
                    <td class="pilot-name">
                        ${p.name}
                        <span class="pilot-id">ID: ${p.id}</span>
                    </td>
                    <td class="total-score">${p.score}</td>
                    <td class="cup-result ${textClass}">${lastResult}</td>
                `;
                tableBody.appendChild(tr);
            });
        }

        function searchPilot() {
            let input = document.getElementById("searchInput").value.toUpperCase();
            let rows = document.querySelectorAll("tbody tr");
            let activeBtn = document.querySelector(".filter-btn.active");
            let currentTier = 'all';
            if (activeBtn.classList.contains("btn-plat")) currentTier = 'platinum';
            else if (activeBtn.classList.contains("btn-gold")) currentTier = 'gold';
            else if (activeBtn.classList.contains("btn-silver")) currentTier = 'silver';
            else if (activeBtn.classList.contains("btn-bronze")) currentTier = 'bronze';

            rows.forEach(row => {
                if(row.dataset.pilotData) {
                    let data = JSON.parse(row.dataset.pilotData);
                    // Match Name OR ID
                    let matchSearch = data.name.toUpperCase().includes(input) || data.id.toString().toUpperCase().includes(input);
                    let matchTier = (currentTier === 'all') || (row.getAttribute("data-tier") === currentTier);
                    row.style.display = (matchSearch && matchTier) ? "" : "none";
                }
            });
        }

        function filterTier(tier) {
            document.querySelectorAll(".filter-btn").forEach(btn => btn.classList.remove("active"));
            let btnClass = tier === 'all' ? '.btn-all' : (tier === 'platinum' ? '.btn-plat' : (tier === 'gold' ? '.btn-gold' : (tier === 'silver' ? '.btn-silver' : '.btn-bronze')));
            document.querySelector(btnClass).classList.add("active");

            if (tier === 'all') {
                tableBody.classList.remove("card-view");
                tableBody.classList.add("list-view");
                document.getElementById("ladderTable").classList.remove("hide-header");
                systemStatus.innerText = "SOLAR CUP // CUMULATIVE RANKING";
            } else {
                tableBody.classList.remove("list-view");
                tableBody.classList.add("card-view");
                document.getElementById("ladderTable").classList.add("hide-header");
                systemStatus.innerText = "SOLAR CUP // DIVISION VIEW";
            }
            searchPilot();
        }

        function openCard(row) {
            const data = JSON.parse(row.dataset.pilotData);

            document.getElementById("mRank").innerText = data.rank;
            document.getElementById("mName").innerText = data.name;
            document.getElementById("mId").innerText = `ID: ${data.id}`;
            document.getElementById("mScore").innerText = data.score;

            const historyList = document.getElementById("mHistoryList");
            historyList.innerHTML = ""; 
            
            if (!data.history || data.history.length === 0) {
                historyList.innerHTML = `<div class="log-row" style="color:#666; justify-content:center;">NO DATA</div>`;
            } else {
                data.history.forEach((result, index) => {
                    const cupName = `SOLAR CUP ${getCupName(index)}`;
                    const div = document.createElement("div");
                    div.className = "log-row";
                    let opacity = 1 - (index * 0.15);
                    if (opacity < 0.3) opacity = 0.3;
                    div.style.opacity = opacity;
                    
                    div.innerHTML = `<span class="log-cup">${cupName}</span><span style="color:#fff;">${result}</span>`;
                    historyList.appendChild(div);
                });
            }

            const q = evaQuotes[Math.floor(Math.random() * evaQuotes.length)];
            document.getElementById("mQuoteJP").innerText = q.jp;
            document.getElementById("mQuoteCN").innerText = q.cn;
            document.getElementById("mQuoteSource").innerText = `—— ${q.source}`;

            let colorVar = "#fff";
            if (data.tierClass === "platinum") colorVar = "var(--color-platinum)";
            else if (data.tierClass === "gold") colorVar = "var(--color-gold)";
            else if (data.tierClass === "silver") colorVar = "var(--color-silver)";
            else if (data.tierClass === "bronze") colorVar = "var(--color-bronze)";
            
            document.getElementById("modalCard").style.borderColor = colorVar;
            document.getElementById("modalCard").style.boxShadow = `0 0 30px ${colorVar}`;
            
            document.body.style.overflow = 'hidden'; 
            document.getElementById("playerModal").style.display = "flex";
        }

        function closeModal() {
            document.body.style.overflow = '';
            document.getElementById("playerModal").style.display = "none";
        }
        window.onclick = function(event) {
            if (event.target == document.getElementById("playerModal")) closeModal();
        }
    </script>
</body>
</html>
