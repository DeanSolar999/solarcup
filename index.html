<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>曜日天梯榜 - MAGI SYSTEM</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --eva-dark-bg: #0b0b0e;
            --eva-purple: #9d5df2;
            --eva-green: #39ff14;
            --eva-orange: #ff9900;
            --color-platinum: #00bfff;
            --color-gold: #ffd700;
            --color-silver: #ff0f4f;
            --color-bronze: #39ff14;
            --glass-bg: rgba(25, 25, 30, 0.75);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            background-color: var(--eva-dark-bg);
            color: #fff;
            font-family: 'Helvetica Neue', Arial, '微軟正黑體', sans-serif;
            margin: 0; padding: 0;
            background-image: 
                radial-gradient(circle at center, transparent 0%, #000 90%),
                linear-gradient(0deg, rgba(157, 93, 242, 0.05) 1px, transparent 1px), 
                linear-gradient(90deg, rgba(157, 93, 242, 0.05) 1px, transparent 1px);
            background-size: 100% 100%, 30px 30px, 30px 30px;
            min-height: 100vh;
        }

        /* === Loading === */
        #loadingOverlay {
            display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 9999; align-items: center; justify-content: center; flex-direction: column;
        }
        .loader-text { color: var(--eva-orange); font-family: 'Impact'; font-size: 2rem; animation: blink 0.5s infinite alternate; }

        @keyframes blink { from { opacity: 1; } to { opacity: 0.3; } }

        /* === Header & Filter === */
        .sticky-controls {
            position: sticky; top: 0; z-index: 1000;
            background: rgba(11, 11, 14, 0.9);
            backdrop-filter: blur(15px);
            border-bottom: 2px solid var(--eva-purple);
            padding: 10px 0;
            transition: all 0.3s ease;
        }

        .title-card { font-family: "MS Mincho", serif; text-align: center; font-size: 1.8rem; letter-spacing: 5px; text-shadow: 0 0 10px var(--eva-purple); margin: 0; }
        .sub-title { text-align: center; font-size: 0.7rem; color: var(--eva-green); letter-spacing: 2px; margin-bottom: 8px; font-weight: bold; }

        .filter-container { width: 100%; overflow-x: auto; padding: 5px 10px; }
        .filter-group { display: flex; justify-content: center; gap: 8px; white-space: nowrap; }
        
        .filter-btn {
            background: rgba(255,255,255,0.05); border: 1px solid #444;
            color: #888; padding: 6px 14px; cursor: pointer;
            font-size: 0.75rem; border-radius: 4px; transition: 0.2s;
        }
        .filter-btn.active { color: #000; font-weight: bold; border-color: transparent; transform: translateY(-2px); }
        .btn-all.active { background: #fff; box-shadow: 0 0 10px #fff; }
        .btn-plat.active { background: var(--color-platinum); box-shadow: 0 0 10px var(--color-platinum); }
        .btn-gold.active { background: var(--color-gold); box-shadow: 0 0 10px var(--color-gold); }
        .btn-silver.active { background: var(--color-silver); box-shadow: 0 0 10px var(--color-silver); }
        .btn-bronze.active { background: var(--color-bronze); box-shadow: 0 0 10px var(--color-bronze); }

        .search-box { display: flex; justify-content: center; padding: 5px 15px; }
        #searchInput {
            background: rgba(0,0,0,0.6); border: 1px solid var(--eva-purple);
            color: #fff; padding: 10px; width: 100%; max-width: 500px;
            text-align: center; border-radius: 20px; font-size: 0.9rem;
        }

        /* === Table System === */
        .ladder-wrapper { max-width: 1000px; margin: 0 auto; padding: 10px; }
        .system-bar {
            background: linear-gradient(90deg, var(--eva-purple), transparent);
            padding: 4px 15px; font-size: 0.7rem; letter-spacing: 1px; margin-bottom: 10px;
        }

        table { width: 100%; border-spacing: 0 4px; }
        th { color: #666; font-size: 0.7rem; padding: 10px; text-transform: uppercase; }
        
        /* List View Row Style */
        tbody.list-view tr { transition: all 0.2s; cursor: pointer; background: var(--glass-bg); }
        tbody.list-view tr:hover { 
            background: rgba(157, 93, 242, 0.15); 
            box-shadow: inset 0 0 15px rgba(157, 93, 242, 0.2);
        }
        tbody.list-view td { padding: 12px 5px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.05); }

        /* Tier Indicator Left Line */
        .row-platinum { border-left: 4px solid var(--color-platinum); }
        .row-gold { border-left: 4px solid var(--color-gold); }
        .row-silver { border-left: 4px solid var(--color-silver); }
        .row-bronze { border-left: 4px solid var(--color-bronze); }

        .rank-num { font-family: 'Impact'; font-size: 1.4rem; font-style: italic; }
        .pilot-name { font-weight: bold; font-size: 1rem; color: #fff; }
        .pilot-id { font-size: 0.65rem; color: #666; font-family: monospace; display: block; }
        .total-score { font-family: 'Impact'; font-size: 1.3rem; color: var(--eva-green); }

        /* === Card View (Grid) === */
        tbody.card-view { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; }
        tbody.card-view tr { 
            display: flex; flex-direction: column; background: var(--glass-bg); 
            border: 1px solid #333; border-radius: 8px; overflow: hidden; position: relative;
            backdrop-filter: blur(5px);
        }
        tbody.card-view td { display: block; width: 100%; border: none; text-align: left; padding: 10px 15px; }
        tbody.card-view .rank-num { position: absolute; top: 10px; right: 15px; opacity: 0.2; font-size: 3rem; }
        tbody.card-view .cup-result { background: rgba(0,0,0,0.3); font-size: 0.85rem; border-top: 1px dashed #444; }

        /* === Modal (Eva Card) === */
        .modal {
            display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); backdrop-filter: blur(10px); align-items: center; justify-content: center;
        }
        .modal-content {
            background: rgba(20, 20, 25, 0.95); border-top: 4px solid var(--eva-purple);
            width: 90%; max-width: 400px; padding: 25px; border-radius: 4px;
            box-shadow: 0 0 50px rgba(0,0,0,1); position: relative;
            animation: slideUp 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.28);
        }
        @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .close-modal { position: absolute; top: 10px; right: 15px; font-size: 24px; color: #555; cursor: pointer; }
        .p-rank-big { font-family: 'Impact'; font-size: 4rem; color: rgba(255,255,255,0.05); position: absolute; top: 10px; right: 20px; z-index: 0; }
        
        .p-sync-box { 
            background: rgba(57, 255, 20, 0.1); border: 1px solid var(--eva-green);
            padding: 10px; text-align: center; margin: 15px 0;
        }
        .sync-label { font-size: 0.6rem; color: var(--eva-green); letter-spacing: 2px; display: block; }
        .sync-value { font-family: 'Impact'; font-size: 2.5rem; color: #fff; }

        .battle-log { max-height: 180px; overflow-y: auto; background: #000; padding: 10px; border: 1px solid #222; margin-top: 10px; }
        .log-item { display: flex; justify-content: space-between; font-size: 0.85rem; padding: 5px 0; border-bottom: 1px solid #111; }
        .log-cup { color: var(--eva-purple); font-weight: bold; }

        .eva-quote { 
            border-left: 3px solid var(--eva-orange); padding-left: 10px; margin-top: 20px; 
            font-size: 0.9rem; font-style: italic; color: #ccc;
        }

        /* Responsive */
        @media (max-width: 600px) {
            .title-card { font-size: 1.4rem; }
            tbody.card-view { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <div id="loadingOverlay">
        <div class="loader-text">MAGI SYSTEM ONLINE</div>
    </div>

    <div id="playerModal" class="modal">
        <div class="modal-content" id="modalCard">
            <span class="close-modal" onclick="closeModal()">&times;</span>
            <div class="p-rank-big" id="mRankBg">01</div>
            
            <div style="position:relative; z-index:1;">
                <div style="font-size: 0.7rem; color: var(--eva-purple); font-weight: bold;">PILOT DATA ANALYZING...</div>
                <div id="mName" style="font-size: 1.8rem; font-weight: 900; margin: 5px 0;">NAME</div>
                <div id="mId" style="font-size: 0.8rem; color: #666; font-family: monospace;">ID: P-000</div>
                
                <div class="p-sync-box">
                    <span class="sync-label">TOTAL SYNCHRONIZATION RATE</span>
                    <span class="sync-value" id="mScore">0</span><span style="font-family:'Impact'; color:var(--eva-green); font-size:1.2rem; margin-left:5px;">%</span>
                </div>

                <div style="font-size: 0.65rem; color: #555; margin-bottom: 5px; letter-spacing: 1px;">BATTLE RECORDS</div>
                <div class="battle-log" id="mHistoryList"></div>

                <div class="eva-quote" id="mQuote">
                    "不能逃避、不能逃避、不能逃避。"
                </div>
            </div>
        </div>
    </div>

    <div class="sticky-controls" id="header">
        <div class="title-card">曜日天梯榜</div>
        <div class="sub-title">SOLAR CUP BADMINTON LEAGUE</div>
        
        <div class="filter-container">
            <div class="filter-group">
                <button class="filter-btn btn-all active" onclick="filterTier('all')">ALL (總覽)</button>
                <button class="filter-btn btn-plat" onclick="filterTier('platinum')">白金 (分組)</button>
                <button class="filter-btn btn-gold" onclick="filterTier('gold')">黃金 (分組)</button>
                <button class="filter-btn btn-silver" onclick="filterTier('silver')">白銀 (分組)</button>
                <button class="filter-btn btn-bronze" onclick="filterTier('bronze')">青銅 (分組)</button>
            </div>
        </div>

        <div class="search-box">
            <input type="text" id="searchInput" onkeyup="searchPilot()" placeholder="搜尋選手名稱或編號...">
        </div>
    </div>

    <div class="ladder-wrapper">
        <div class="system-bar" id="systemStatus">MAGI SYSTEM: STANDBY</div>
        
        <table id="ladderTable">
            <thead id="tableHead">
                <tr>
                    <th width="15%">Rank</th>
                    <th width="60%">Pilot / Unit</th>
                    <th width="25%">Sync</th>
                </tr>
            </thead>
            <tbody id="tableBody" class="list-view">
                <tr><td colspan="3" style="text-align:center; padding:50px; color:#444;">INITIALIZING...</td></tr>
            </tbody>
        </table>
    </div>

    <script>
        const GOOGLE_SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vT40Ezc3eu9HtyGZL5bFHuNudksoBz7gVGXycPyGD22vZB2MxO7mCSXVTz-roAUpckS1pZy3dBE9jTy/pub?gid=2080286926&single=true&output=csv"; 

        let allPilots = [];
        const quotes = ["不能逃避。不能逃避。", "我認為只要微笑就好了。", "你不會死的，我會保護你。", "你是笨蛋嗎？", "與其等待奇蹟，不如拚死努力！", "只要活著，哪裡都能成為天堂。"];
        const cupNames = ["ONE", "TWO", "THREE", "FOUR", "FIVE", "SIX", "SEVEN", "EIGHT", "NINE", "TEN"];

        window.onload = fetchCSV;

        function fetchCSV() {
            fetch(GOOGLE_SHEET_CSV_URL + "&t=" + Date.now())
                .then(res => res.arrayBuffer())
                .then(buffer => {
                    const decoder = new TextDecoder("utf-8");
                    const csv = decoder.decode(buffer);
                    const data = XLSX.utils.sheet_to_json(XLSX.read(csv, {type:'string'}).Sheets[XLSX.read(csv, {type:'string'}).SheetNames[0]], {header:1});
                    process(data.slice(1));
                });
        }

        function process(rows) {
            allPilots = rows.map(row => ({
                id: row[0] || "UNK",
                name: row[1] || "Unknown",
                team: row[2] || "-",
                tier: row[3] || "青銅級",
                score: parseInt(row[4]) || 0,
                history: row.slice(5).filter(x => x && x !== "#N/A")
            })).filter(p => p.name !== "Unknown").sort((a,b) => b.score - a.score);

            render(allPilots);
            document.getElementById('loadingOverlay').style.display = 'none';
            document.getElementById('systemStatus').innerText = `MAGI_VER.3.0: SYNCHRONIZED (${allPilots.length}_PILOTS)`;
        }

        function render(pilots) {
            const container = document.getElementById("tableBody");
            container.innerHTML = "";
            let rank = 1;

            pilots.forEach((p, i) => {
                if (i > 0 && p.score < pilots[i-1].score) rank = i + 1;
                
                const tierKey = p.tier.includes("白金") ? "platinum" : p.tier.includes("黃金") ? "gold" : p.tier.includes("白銀") ? "silver" : "bronze";
                const tr = document.createElement("tr");
                tr.className = `row-${tierKey}`;
                tr.dataset.json = JSON.stringify({...p, rank: rank < 10 ? '0'+rank : rank, tierKey});
                tr.onclick = () => openCard(p, rank, tierKey);

                tr.innerHTML = `
                    <td class="rank-num text-${tierKey}">${rank < 10 ? '0'+rank : rank}</td>
                    <td>
                        <div class="pilot-name">${p.name}</div>
                        <div class="pilot-id">${p.id} ${p.team !== '-' ? '| ' + p.team : ''}</div>
                    </td>
                    <td class="total-score">${p.score}</td>
                    <td class="cup-result" style="display:none">LATEST: ${p.history[0] || '-'}</td>
                `;
                container.appendChild(tr);
            });
        }

        function openCard(p, rank, tierKey) {
            const modal = document.getElementById("playerModal");
            const scoreEl = document.getElementById("mScore");
            document.getElementById("mName").innerText = p.name;
            document.getElementById("mId").innerText = `IDENTIFICATION: ${p.id} / ${p.team}`;
            document.getElementById("mRankBg").innerText = rank < 10 ? '0'+rank : rank;
            document.getElementById("mQuote").innerText = `"${quotes[Math.floor(Math.random()*quotes.length)]}"`;
            
            const list = document.getElementById("mHistoryList");
            list.innerHTML = p.history.map((h, i) => `
                <div class="log-item">
                    <span class="log-cup">${cupNames[i] || 'REV'}:</span>
                    <span>${h}</span>
                </div>
            `).join("");

            const color = getComputedStyle(document.documentElement).getPropertyValue(`--color-${tierKey}`);
            document.getElementById("modalCard").style.borderColor = color;
            document.getElementById("modalCard").style.boxShadow = `0 0 30px ${color}44`;

            modal.style.display = "flex";
            
            // Sync Score Animation
            let cur = 0;
            const target = p.score;
            const timer = setInterval(() => {
                if (cur >= target) { scoreEl.innerText = target; clearInterval(timer); }
                else { cur += Math.ceil((target - cur) / 5); scoreEl.innerText = cur; }
            }, 30);
        }

        function filterTier(tier) {
            document.querySelectorAll(".filter-btn").forEach(b => b.classList.remove("active"));
            document.querySelector(`.btn-${tier === 'platinum' ? 'plat' : tier === 'all' ? 'all' : tier}`).classList.add("active");
            
            const body = document.getElementById("tableBody");
            if (tier === 'all') {
                body.classList.replace("card-view", "list-view");
                document.getElementById("tableHead").style.display = "";
            } else {
                body.classList.replace("list-view", "card-view");
                document.getElementById("tableHead").style.display = "none";
            }
            searchPilot();
        }

        function searchPilot() {
            const term = document.getElementById("searchInput").value.toUpperCase();
            const activeTier = document.querySelector(".filter-btn.active").innerText.toLowerCase();
            
            document.querySelectorAll("#tableBody tr").forEach(tr => {
                const data = JSON.parse(tr.dataset.json);
                const matchTerm = data.name.toUpperCase().includes(term) || data.id.toUpperCase().includes(term);
                const matchTier = activeTier.includes("all") || data.tierKey.includes(activeTier.substring(0,2));
                tr.style.display = (matchTerm && matchTier) ? "" : "none";
            });
        }

        function closeModal() { document.getElementById("playerModal").style.display = "none"; }
        window.onclick = e => { if(e.target.className === 'modal') closeModal(); }
    </script>
</body>
</html>
