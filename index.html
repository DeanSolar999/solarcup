<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ÊõúÊó•Â§©Ê¢ØÊ¶ú - SOLAR CUP</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* =========================================
           EVA THEME & CORE STYLES
           ========================================= */
        :root {
            --eva-dark-bg: #0b0b0e;
            --eva-purple: #9d5df2;
            --eva-green: #39ff14;
            --eva-orange: #ff9900;
            --color-platinum: #00bfff;
            --color-gold: #ffd700;
            --color-silver: #ff0f4f;
            --color-bronze: #39ff14;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html { scroll-behavior: smooth; }

        body {
            background-color: var(--eva-dark-bg);
            color: #fff;
            font-family: 'Helvetica Neue', Arial, 'Hiragino Sans', 'Meiryo', 'ÂæÆËªüÊ≠£ÈªëÈ´î', sans-serif;
            margin: 0; padding: 0;
            background-image: 
                radial-gradient(circle at center, transparent 0%, #000 90%),
                linear-gradient(0deg, rgba(157, 93, 242, 0.05) 1px, transparent 1px), 
                linear-gradient(90deg, rgba(157, 93, 242, 0.05) 1px, transparent 1px);
            background-size: 100% 100%, 40px 40px, 40px 40px;
            min-height: 100vh;
            font-size: 16px; 
            display: flex; flex-direction: column;
        }

        /* === Loading Overlay === */
        #loadingOverlay {
            display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 9999;
            align-items: center; justify-content: center; flex-direction: column;
        }
        .loader-text {
            color: var(--eva-orange); font-family: 'Impact'; font-size: 2rem; letter-spacing: 2px;
            animation: blink 0.5s infinite alternate; text-align: center;
        }
        .loader-sub { color: #666; font-size: 0.8rem; margin-top:10px; letter-spacing: 1px; }
        @keyframes blink { from { opacity: 1; } to { opacity: 0.3; } }

        /* === Sticky Header === */
        .sticky-controls {
            position: sticky; top: 0; z-index: 1000;
            background: rgba(11, 11, 14, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 2px solid var(--eva-purple);
            box-shadow: 0 5px 20px rgba(0,0,0,0.8);
            padding-bottom: 5px;
        }

        .title-card {
            font-family: "MS Mincho", "SimSun", serif;
            font-weight: 900; text-align: center; 
            font-size: 2rem; letter-spacing: 0.1em; color: #fff; padding-top: 10px;
            text-shadow: 0 0 10px var(--eva-purple); line-height: 1.1;
        }
        .sub-title {
            text-align: center; font-size: 0.7rem; color: var(--eva-green); 
            letter-spacing: 2px; margin-bottom: 5px; opacity: 0.8; font-weight: bold;
        }

        /* Filter Buttons */
        .filter-container { width: 100%; overflow-x: auto; padding: 0 10px; -webkit-overflow-scrolling: touch; }
        .filter-group { display: flex; justify-content: center; gap: 6px; margin: 5px 0; white-space: nowrap; min-width: max-content; }
        
        .filter-btn {
            background: rgba(0,0,0,0.6); border: 1px solid #444;
            color: #aaa; padding: 6px 12px; cursor: pointer;
            font-size: 0.8rem; letter-spacing: 1px; transition: all 0.2s;
            text-transform: uppercase; border-radius: 4px; flex-shrink: 0;
        }
        .filter-btn.active { color: #000; font-weight: bold; border: none; transform: scale(1.05); }
        .btn-all.active { background: #fff; box-shadow: 0 0 8px #fff; }
        .btn-plat.active { background: var(--color-platinum); box-shadow: 0 0 8px var(--color-platinum); }
        .btn-gold.active { background: var(--color-gold); box-shadow: 0 0 8px var(--color-gold); }
        .btn-silver.active { background: var(--color-silver); box-shadow: 0 0 8px var(--color-silver); }
        .btn-bronze.active { background: var(--color-bronze); box-shadow: 0 0 8px var(--color-bronze); }

        .search-box { display: flex; justify-content: center; padding: 5px 15px; margin-top: 5px;}
        #searchInput {
            background: rgba(0,0,0,0.5); border: 1px solid var(--eva-purple);
            color: #fff; padding: 8px; width: 100%; max-width: 500px;
            text-align: center; font-size: 0.9rem; border-radius: 4px;
        }

        /* === Mobile Adjustments === */
        @media (max-width: 600px) {
            .title-card { font-size: 1.5rem; }
            .filter-group { justify-content: flex-start; }
            th:nth-child(1) { width: 15% !important; }
            th:nth-child(2) { width: 45% !important; } /* Â¢ûÂä†ÂßìÂêçÊ¨ÑÂØ¨Â∫¶ */
            th:nth-child(3) { width: 25% !important; } /* ÁêÉÂúò */
            th:nth-child(4) { width: 15% !important; } /* ÂàÜÊï∏ */
        }

        /* === Table System === */
        .ladder-wrapper { max-width: 1200px; margin: 0 auto; padding-bottom: 20px; flex-grow: 1; width: 100%;}
        .system-bar {
            background: linear-gradient(90deg, var(--eva-purple), transparent);
            color: #fff; padding: 5px 15px; font-size: 0.75rem;
            letter-spacing: 2px; margin-top: 10px; font-weight: bold;
        }

        table { width: 100%; border-collapse: separate; border-spacing: 0 4px; table-layout: fixed; }
        thead th {
            background: #151515; color: #888; padding: 10px 5px;
            border-bottom: 2px solid var(--eva-purple);
            font-size: 0.75rem; letter-spacing: 0.5px; text-transform: uppercase;
            overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
        }
        th.th-total { color: var(--eva-green); border-bottom: 2px solid var(--eva-green); }

        tr { position: relative; }
        td {
            padding: 10px 2px; text-align: center;
            background: rgba(30,30,35,0.7);
            border: 1px solid transparent;
            font-size: 0.95rem; color: #ddd; vertical-align: middle; cursor: pointer;
            overflow: hidden; text-overflow: ellipsis;
        }

        /* List View */
        tbody.list-view td:first-child {
            position: relative;
            background-image: linear-gradient(30deg, #000 12%, transparent 12.5%, transparent 87%, #000 87.5%, #000), linear-gradient(150deg, #000 12%, transparent 12.5%, transparent 87%, #000 87.5%, #000), linear-gradient(60deg, rgba(255,255,255,0.05) 25%, transparent 25.5%, transparent 75%, rgba(255,255,255,0.05) 75%, rgba(255,255,255,0.05));
            background-size: 20px 35px; box-shadow: inset 4px 0 0 0 currentColor;
        }
        
        .rank-num { font-family: 'Impact', sans-serif; font-size: 1.3rem; font-style: italic; }
        .pilot-name { font-weight: bold; color: #fff; font-size: 1rem; line-height: 1.2; display: flex; flex-direction: column; align-items: center; justify-content: center;}
        .pilot-id { font-size: 0.65rem; color: #888; font-weight: normal; letter-spacing: 0.5px; margin-top: 2px; font-family: monospace; display: block;}
        
        /* ÁêÉÂúòÊ®£Âºè */
        .pilot-team { 
            color: var(--eva-orange); font-size: 0.8rem; font-weight: bold; letter-spacing: 1px;
            border: 1px solid #444; padding: 2px 6px; border-radius: 4px; background: rgba(0,0,0,0.3);
            display: inline-block;
        }

        .total-score { font-weight: bold; color: var(--eva-green); font-size: 1.2rem; font-family: 'Impact', sans-serif; }
        
        .text-platinum { color: var(--color-platinum); }
        .text-gold { color: var(--color-gold); }
        .text-silver { color: var(--color-silver); }
        .text-bronze { color: var(--color-bronze); }

        tbody.list-view tr:hover td { background: rgba(255,255,255,0.15); }

        /* === Card View === */
        tbody.card-view { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; padding: 10px; }
        tbody.card-view tr {
            display: flex; flex-wrap: wrap; width: 100%; max-width: 450px;
            margin: 0; padding: 0; background: rgba(25,25,30,0.9);
            box-shadow: 0 4px 15px rgba(0,0,0,0.6); border-radius: 6px; overflow: hidden;
            border: 1px solid #333; transition: transform 0.1s;
        }
        tbody.card-view tr:active { transform: scale(0.98); }

        /* Â∑¶‰∏äÔºöÊéíÂêç */
        tbody.card-view td:nth-of-type(1) { 
            width: 20%; font-size: 2rem; text-align: center; 
            display: flex; align-items: center; justify-content: center;
            background-image: linear-gradient(30deg, #000 12%, transparent 12.5%, transparent 87%, #000 87.5%, #000), linear-gradient(60deg, rgba(255,255,255,0.05) 25%, transparent 25.5%, transparent 75%, rgba(255,255,255,0.05) 75%, rgba(255,255,255,0.05));
            background-size: 20px 35px; box-shadow: inset 5px 0 0 0 currentColor; padding: 15px 0;
        }
        /* Âè≥‰∏äÔºöÂêçÂ≠ó„ÄÅID„ÄÅÁêÉÂúò */
        tbody.card-view td:nth-of-type(2) { 
            width: 75%; font-size: 1.3rem; border-bottom: 1px solid #444 !important; 
            margin: 10px 0 5px 5px; background: none !important; text-align: left; padding-left: 10px;
            align-items: flex-start; display: flex; flex-direction: column; justify-content: center;
        }
        tbody.card-view .pilot-name { align-items: flex-start; }
        
        /* Card View Ë£°ÁöÑÁêÉÂúòÈ°ØÁ§∫Ë™øÊï¥ */
        .card-team-badge {
            font-size: 0.75rem; color: var(--eva-orange); border: 1px solid var(--eva-orange);
            padding: 1px 5px; margin-top: 5px; border-radius: 3px; display: inline-block;
        }

        /* ‰∏ãÊñπÔºöÁ∏ΩÂàÜ (ÂÖ®ÂØ¨) */
        tbody.card-view td:nth-of-type(3) { 
            width: 100%; margin: 0; padding: 10px 15px; display: flex; justify-content: space-between; align-items: center;
            background: rgba(0,0,0,0.3) !important; border-top: 1px dashed #444 !important;
        }
        tbody.card-view td:nth-of-type(3)::before { content: "TOTAL SYNC"; font-size: 0.8rem; color: #888; }
        
        /* Èö±ËóèÁ¨¨4Ê¨Ñ (ÁêÉÂúòÊ¨Ñ‰ΩçÂú®List ViewÊòØÁç®Á´ãÁöÑÔºå‰ΩÜÂú®Card ViewÂêà‰ΩµÂà∞ÂêçÂ≠óË£°ÔºåÊâÄ‰ª•ÈÄôË£°Èö±Ëóè) */
        tbody.card-view td:nth-of-type(4) { display: none; }
        
        tbody.card-view tr::after {
            content: "TAP FOR BATTLE LOG >>"; display: block; width: 100%; text-align: right;
            font-size: 0.65rem; color: #555; padding: 5px 15px; letter-spacing: 1px;
        }
        .hide-header thead { display: none; }

        /* === Modal === */
        .modal {
            display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.9); backdrop-filter: blur(8px); align-items: center; justify-content: center; padding: 15px;
        }
        .modal-content {
            background: #15151a; border: 2px solid var(--eva-purple); width: 100%; max-width: 400px; 
            max-height: 90vh; display: flex; flex-direction: column;
            padding: 20px; position: relative;
            box-shadow: 0 0 40px var(--eva-purple); border-radius: 8px; animation: modalPop 0.3s;
        }
        @keyframes modalPop { 0% { transform: scale(0.9); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        .close-modal { position: absolute; top: 5px; right: 10px; color: #888; font-size: 32px; cursor: pointer; padding: 10px; z-index: 10; }
        
        .pilot-header { display: flex; align-items: center; margin-bottom: 15px; border-bottom: 1px solid #333; padding-bottom: 15px; flex-shrink: 0; }
        .p-rank { font-size: 3.5rem; font-family: 'Impact'; margin-right: 15px; line-height: 1; color: #fff; }
        .p-name { font-size: 1.6rem; font-weight: bold; color: #fff; display: block; line-height: 1.2;}
        .p-id-modal { font-size: 0.9rem; color: #666; font-family: monospace; display: block; margin-top: 3px; letter-spacing: 1px;}

        .battle-log-container {
            background: #08080a; border: 1px solid #333; border-radius: 4px; margin-bottom: 15px;
            flex-grow: 1; overflow-y: auto; max-height: 250px; padding: 10px;
            scrollbar-width: thin; scrollbar-color: var(--eva-purple) #000;
        }
        .log-title { font-size: 0.75rem; color: #888; border-bottom: 1px solid #444; margin-bottom: 10px; padding-bottom: 5px; letter-spacing: 2px; position: sticky; top:0; background: #08080a; }
        .log-row { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 0.9rem; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 5px; align-items: center;}
        
        /* üåü ‰øÆÊîπÊà∞Á∏æÈ°ØÁ§∫Ê®£Âºè */
        .log-cup-name { color: var(--eva-purple); font-weight: bold; font-family: 'Arial Black', sans-serif; letter-spacing: 0.5px; margin-right: 5px;}
        .log-full-text { color: #fff; font-size: 0.95rem; }

        .eva-quote-box {
            padding: 12px; background: rgba(255, 153, 0, 0.05); border-left: 4px solid var(--eva-orange);
            text-align: center; margin-bottom: 5px; flex-shrink: 0; position: relative;
        }
        .quote-cn { display: block; font-size: 1.1rem; color: #fff; font-weight: bold; margin-bottom: 5px; text-shadow: 0 0 5px rgba(0,0,0,0.5); }
        .quote-jp { display: block; font-size: 0.75rem; color: #888; font-family: "MS Mincho", serif; margin-bottom: 5px; }
        .quote-source { display: block; text-align: right; font-size: 0.7rem; color: var(--eva-orange); font-weight: bold; }
        .quote-label { display: block; font-size: 0.5rem; color: #666; text-align: left; margin-bottom: 5px; letter-spacing: 2px; }

        .bottom-admin-panel {
            text-align: center; padding: 20px 0 40px 0; margin-top: auto;
            border-top: 1px solid #222; background: rgba(0,0,0,0.5);
        }
        .footer-deco { text-align: center; font-size: 0.65rem; color: #555; padding: 10px; line-height: 1.5; }
    </style>
</head>
<body>

    <div id="loadingOverlay">
        <div class="loader-text">MAGI SYSTEM PROCESSING...</div>
        <div class="loader-sub">CONNECTING TO SOLAR DATABASE...</div>
    </div>

    <div id="playerModal" class="modal">
        <div class="modal-content" id="modalCard">
            <span class="close-modal" onclick="closeModal()">&times;</span>
            
            <div class="pilot-header">
                <div id="mRank" class="p-rank">01</div>
                <div class="p-info">
                    <span id="mName" class="p-name">NAME</span>
                    <span id="mId" class="p-id-modal">ID: P-001</span>
                    <span id="mTeam" style="color:var(--eva-orange); font-size:0.8rem; border:1px solid; padding:0 4px; border-radius:3px; margin-top:3px; display:inline-block;">TEAM</span>
                    <div style="font-size: 0.8rem; color: var(--eva-green); letter-spacing: 1px; margin-top:5px;">TOTAL SYNC: <span id="mScore" style="color:#fff; font-size:1.4rem; font-weight:bold;">400</span></div>
                </div>
            </div>

            <div class="battle-log-container">
                <div class="log-title">BATTLE LOG (Ê≠∑Âè≤Êà∞Á∏æ)</div>
                <div id="mHistoryList"></div>
            </div>

            <div class="eva-quote-box">
                <span class="quote-label">VOICE DATA RECORDING</span>
                <span id="mQuoteCN" class="quote-cn">"‰∏çËÉΩÈÄÉÈÅø„ÄÇ"</span>
                <span id="mQuoteJP" class="quote-jp">ÈÄÉ„Åí„Å°„ÇÉ„ÉÄ„É°„Å†„ÄÇ</span>
                <span id="mQuoteSource" class="quote-source">‚Äî‚Äî Á¢á„Ç∑„É≥„Ç∏</span>
            </div>
            
            <div style="margin-top: 10px; font-size: 0.7rem; color: #444; text-align: right;">NERV PERSONNEL FILE: CLASSIFIED</div>
        </div>
    </div>

    <div class="sticky-controls">
        <div class="title-card">ÊõúÊó•Â§©Ê¢ØÊ¶ú</div>
        <div class="sub-title">SOLAR CUP BADMINTON LEAGUE</div>
        
        <div class="filter-container">
            <div class="filter-group">
                <button class="filter-btn btn-all active" onclick="filterTier('all')">ALL (Á∏ΩË¶Ω)</button>
                <button class="filter-btn btn-plat" onclick="filterTier('platinum')">ÁôΩÈáë (ÂàÜÁµÑ)</button>
                <button class="filter-btn btn-gold" onclick="filterTier('gold')">ÈªÉÈáë (ÂàÜÁµÑ)</button>
                <button class="filter-btn btn-silver" onclick="filterTier('silver')">ÁôΩÈäÄ (ÂàÜÁµÑ)</button>
                <button class="filter-btn btn-bronze" onclick="filterTier('bronze')">ÈùíÈäÖ (ÂàÜÁµÑ)</button>
            </div>
        </div>

        <div class="search-box">
            <input type="text" id="searchInput" onkeyup="searchPilot()" placeholder="Ëº∏ÂÖ•ÈÅ∏ÊâãÂêçÁ®±ÊàñÁ∑®ËôüÊêúÂ∞ã (SEARCH)...">
        </div>
    </div>

    <div class="ladder-wrapper">
        <div class="system-bar" id="systemStatus">WAITING FOR DATA SYNCHRONIZATION...</div>
        
        <table id="ladderTable">
            <thead>
                <tr>
                    <th width="15%">RANK</th>
                    <th width="40%">PILOT</th>
                    <th width="25%">TEAM</th>
                    <th width="20%" class="th-total">SYNC</th>
                </tr>
            </thead>
            <tbody id="tableBody" class="list-view">
                <tr>
                    <td colspan="4" style="padding: 50px; color: #666; font-style: italic;">
                        WAITING FOR MAGI CONNECTION...
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="bottom-admin-panel">
        <div class="footer-deco">NERV TOKYO-3 // MAGI SYSTEM VER 32.0 // TEAM DATA ADDED</div>
    </div>

    <script>
        // =========================================================
        // üåü Google Sheet CSV URL
        const GOOGLE_SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vT40Ezc3eu9HtyGZL5bFHuNudksoBz7gVGXycPyGD22vZB2MxO7mCSXVTz-roAUpckS1pZy3dBE9jTy/pub?gid=2080286926&single=true&output=csv"; 
        // =========================================================

        const tableBody = document.getElementById("tableBody");
        const systemStatus = document.getElementById("systemStatus");
        
        const evaQuotes = [
            { jp: "ÈÄÉ„Åí„Å°„ÇÉ„ÉÄ„É°„Å†„ÄÇÈÄÉ„Åí„Å°„ÇÉ„ÉÄ„É°„Å†„ÄÇ", cn: "‰∏çËÉΩÈÄÉÈÅø„ÄÇ‰∏çËÉΩÈÄÉÈÅø„ÄÇ", source: "Á¢á„Ç∑„É≥„Ç∏" },
            { jp: "Á¨ë„Åà„Å∞„ÅÑ„ÅÑ„Å®ÊÄù„ÅÜ„Çà„ÄÇ", cn: "ÊàëË™çÁÇ∫‰Ω†Âè™Ë¶ÅÂæÆÁ¨ëÂ∞±Â•Ω‰∫Ü„ÄÇ", source: "Á¢á„Ç∑„É≥„Ç∏" },
            { jp: "„ÅÇ„Å™„Åü„ÅØÊ≠ª„Å™„Å™„ÅÑ„Çè„ÄÅÁßÅ„ÅåÂÆà„Çã„ÇÇ„ÅÆ„ÄÇ", cn: "‰Ω†‰∏çÊúÉÊ≠ªÁöÑÔºåÊàëÊúÉ‰øùË≠∑‰Ω†„ÄÇ", source: "Á∂æÊ≥¢„É¨„Ç§" },
            { jp: "„ÅÇ„Çì„Åü„Éê„Ç´„ÅÅÔºü", cn: "‰Ω†ÊòØÁ¨®ËõãÂóéÔºü", source: "ÂºèÊ≥¢„Éª„Ç¢„Çπ„Ç´„Éª„É©„É≥„Ç∞„É¨„Éº" },
            { jp: "Â•áË∑°„ÇíÂæÖ„Å§„Çà„Çä„ÄÅÊç®„Å¶Ë∫´„ÅÆÂä™Âäõ„ÇàÔºÅ", cn: "ËàáÂÖ∂Á≠âÂæÖÂ•áËπüÔºå‰∏çÂ¶ÇÊãöÊ≠ªÂä™ÂäõÔºÅ", source: "ËëõÂüé„Éü„Çµ„Éà" },
            { jp: "Â§ß‰∫∫„ÅÆ„Ç≠„Çπ„Çà„ÄÇÂ∏∞„Å£„Å¶„Åç„Åü„ÇâÁ∂ö„Åç„Çí„Åó„Åæ„Åó„Çá„ÅÜ„ÄÇ", cn: "ÈÄôÊòØÂ§ß‰∫∫ÁöÑÂêªÂñî„ÄÇÁ≠âÂõû‰æÜ‰πãÂæåÂÜçÁπºÁ∫åÂêß„ÄÇ", source: "ËëõÂüé„Éü„Çµ„Éà" },
            { jp: "Áîü„Åç„Å¶„Åï„Åà„ÅÑ„Çå„Å∞„ÄÅ„Å©„Åì„Å†„Å£„Å¶Â§©ÂõΩ„Å´„Å™„Çã„Çè„ÄÇ", cn: "Âè™Ë¶ÅÊ¥ªËëóÔºåÂì™Ë£°ÈÉΩËÉΩÊàêÁÇ∫Â§©Â†Ç„ÄÇ", source: "„É¶„Ç§ / „Ç≤„É≥„Éâ„Ç¶" },
            { jp: "Ê≠å„ÅØ„ÅÑ„ÅÑ„Å≠„ÄÇÊ≠å„ÅØÂøÉ„ÇíÊΩ§„Åó„Å¶„Åè„Çå„Çã„ÄÇ", cn: "Ê≠åÁúüÂ•ΩÂïä„ÄÇÊ≠åËÉΩ‰ª•Ê≠§ÊΩ§Êæ§ÂøÉÈùà„ÄÇ", source: "Ê∏ö„Ç´„É≤„É´" },
            { jp: "Âêõ„Å´‰ºö„ÅÜ„Åü„ÇÅ„Å´Áîü„Åæ„Çå„Å¶„Åç„Åü„ÅÆ„Åã„ÇÇ„Åó„Çå„Å™„ÅÑ„ÄÇ", cn: "Êàë‰πüË®±Â∞±ÊòØÁÇ∫‰∫ÜËàá‰Ω†Áõ∏ÈÅáÊâçÂá∫ÁîüÁöÑ„ÄÇ", source: "Ê∏ö„Ç´„É≤„É´" },
            { jp: "ÊôÇË®à„ÅÆÈáù„ÅØÂÖÉ„Å´„ÅØÊàª„Çâ„Å™„ÅÑ„ÄÇ„Å†„Åå„ÄÅËá™„Çâ„ÅÆÊâã„ÅßÈÄ≤„ÇÅ„Çã„Åì„Å®„ÅØ„Åß„Åç„Çã„ÄÇ", cn: "ÊôÇÈêòÁöÑÊåáÈáùÁÑ°Ê≥ïÂÄíËΩâ„ÄÇ‰ΩÜÂèØ‰ª•Áî®Ëá™Â∑±ÁöÑÊâãÂéªÊé®ÈÄ≤„ÄÇ", source: "Á¢á„Ç≤„É≥„Éâ„Ç¶" },
            { jp: "Ëá™ÂàÜ„Å´„ÅØ„ÄÅËá™ÂàÜ‰ª•Â§ñ„ÅÆ‰∫∫Èñì„Å®„ÅÆÈñì„Å´„ÅÇ„ÇãÂ£Å„ÄÅÂøÉ„ÅÆÂ£Å„Åå„ÅÇ„Çã„ÄÇ", cn: "‰∫∫Ëàá‰∫∫‰πãÈñìÊúâËëóÈöîÈñ°ÔºåÈÇ£ÊòØÂøÉ‰πãÂ£Å„ÄÇ", source: "Ê∏ö„Ç´„É≤„É´" },
            { jp: "„Åï„Çà„ÅÜ„Å™„Çâ„ÄÅÂÖ®„Å¶„ÅÆ„Ç®„É¥„Ç°„É≥„Ç≤„É™„Ç™„É≥„ÄÇ", cn: "ÂÜçË¶ã‰∫ÜÔºåÊâÄÊúâÁöÑÁ¶èÈü≥Êà∞Â£´„ÄÇ", source: "ÁúüÂ∏åÊ≥¢" }
        ];

        const cupNames = ["ONE", "TWO", "THREE", "FOUR", "FIVE", "SIX", "SEVEN", "EIGHT", "NINE", "TEN", "ELEVEN", "TWELVE"];
        function getCupName(index) {
            return cupNames[index] || `NO.${index + 1}`;
        }

        window.onload = function() {
            fetchGoogleSheetData();
        };

        function fetchGoogleSheetData() {
            const urlWithCacheBust = GOOGLE_SHEET_CSV_URL + "&t=" + Date.now();
            fetch(urlWithCacheBust)
                .then(response => {
                    if (!response.ok) throw new Error("Network response was not ok");
                    return response.arrayBuffer();
                })
                .then(data => {
                    const decoder = new TextDecoder("utf-8");
                    const csvString = decoder.decode(data);
                    const workbook = XLSX.read(csvString, {type: 'string'});
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, {header: 1});
                    
                    if(jsonData.length > 1) {
                        processData(jsonData.slice(1));
                    } else {
                        throw new Error("No data found in sheet");
                    }
                })
                .catch(error => {
                    console.error("Error fetching data:", error);
                    systemStatus.innerText = "CONNECTION FAILED // PLEASE CHECK URL";
                    document.getElementById('loadingOverlay').style.display = 'none';
                });
        }

        function processData(rawData) {
            // ‚ö†Ô∏è Ê¨Ñ‰ΩçÁµêÊßãÂ∑≤ËÆäÊõ¥Ôºö
            // A[0]=ID, B[1]=Name, C[2]=Team(ÁêÉÂúò), D[3]=Tier, E[4]=Score, F[5]...=History
            let pilots = rawData.map(row => {
                if (!row || row.length === 0) return null;
                
                let history = [];
                // History starts from F (index 5)
                if (row.length > 5) {
                    for(let i = 5; i < row.length; i++) {
                        if(row[i] !== undefined && row[i] !== null && row[i].toString().trim() !== "") {
                            if(row[i].toString() === "#N/A") {
                                history.push("-");
                            } else {
                                history.push(row[i]);
                            }
                        }
                    }
                }

                return {
                    id: row[0] || "UNK",
                    name: row[1] || "UNKNOWN",
                    team: row[2] || "-", // Êñ∞Â¢ûÁêÉÂúòÊ¨Ñ‰Ωç
                    tier: row[3] || "ÈùíÈäÖÁ¥ö", 
                    score: typeof row[4] === 'number' ? row[4] : parseInt(row[4]) || 0,
                    history: history 
                };
            }).filter(item => item !== null && item.name !== "UNKNOWN");

            pilots.sort((a, b) => b.score - a.score);
            renderTable(pilots);
            
            document.getElementById('loadingOverlay').style.display = 'none';
            systemStatus.innerText = `SYNC COMPLETE // ${pilots.length} PILOTS LOADED`;
        }

        function renderTable(pilots) {
            tableBody.innerHTML = "";
            let currentRank = 1;

            pilots.forEach((p, index) => {
                if (index > 0 && p.score < pilots[index - 1].score) {
                    currentRank = index + 1;
                }
                
                const tr = document.createElement('tr');
                const rankDisplay = currentRank < 10 ? `0${currentRank}` : currentRank;
                
                let tierClass = "bronze";
                let textClass = "text-bronze";
                const tierStr = p.tier ? p.tier.toString() : "";
                if (tierStr.indexOf("ÁôΩÈáë") > -1) { tierClass = "platinum"; textClass = "text-platinum"; }
                else if (tierStr.indexOf("ÈªÉÈáë") > -1) { tierClass = "gold"; textClass = "text-gold"; }
                else if (tierStr.indexOf("ÁôΩÈäÄ") > -1) { tierClass = "silver"; textClass = "text-silver"; }

                tr.className = `row-${tierClass}`;
                tr.setAttribute('data-tier', tierClass);
                
                tr.dataset.pilotData = JSON.stringify({
                    rank: rankDisplay,
                    id: p.id,
                    name: p.name,
                    team: p.team,
                    score: p.score,
                    history: p.history,
                    tierClass: tierClass
                });
                
                tr.onclick = function() { openCard(this); };

                // ËôïÁêÜÁêÉÂúòÈ°ØÁ§∫ (Â¶ÇÊûúÊ≤íÊúâÁêÉÂúòÊàñÈ°ØÁ§∫-)
                let teamDisplay = p.team;
                if(teamDisplay === "-" || teamDisplay === "0") teamDisplay = "";

                // Card View Áî®ÁöÑÂêçÂ≠ó+ÁêÉÂúò HTML
                let nameHtml = `${p.name}<span class="pilot-id">${p.id}</span>`;
                if(teamDisplay) {
                    nameHtml += `<span class="card-team-badge">${teamDisplay}</span>`;
                }

                // List View Áî®ÁöÑÁêÉÂúòÊ¨Ñ‰Ωç
                let listTeamHtml = teamDisplay ? `<span class="pilot-team">${teamDisplay}</span>` : `<span style="color:#444;">-</span>`;

                tr.innerHTML = `
                    <td class="rank-num ${textClass}">${rankDisplay}</td>
                    <td class="pilot-name">${nameHtml}</td>
                    <td class="cup-result">${listTeamHtml}</td>
                    <td class="total-score">${p.score}</td>
                `;
                tableBody.appendChild(tr);
            });
        }

        function searchPilot() {
            let input = document.getElementById("searchInput").value.toUpperCase();
            let rows = document.querySelectorAll("tbody tr");
            let activeBtn = document.querySelector(".filter-btn.active");
            let currentTier = 'all';
            if (activeBtn.classList.contains("btn-plat")) currentTier = 'platinum';
            else if (activeBtn.classList.contains("btn-gold")) currentTier = 'gold';
            else if (activeBtn.classList.contains("btn-silver")) currentTier = 'silver';
            else if (activeBtn.classList.contains("btn-bronze")) currentTier = 'bronze';

            rows.forEach(row => {
                if(row.dataset.pilotData) {
                    let data = JSON.parse(row.dataset.pilotData);
                    let matchSearch = data.name.toUpperCase().includes(input) || data.id.toString().toUpperCase().includes(input);
                    let matchTier = (currentTier === 'all') || (row.getAttribute("data-tier") === currentTier);
                    row.style.display = (matchSearch && matchTier) ? "" : "none";
                }
            });
        }

        function filterTier(tier) {
            document.querySelectorAll(".filter-btn").forEach(btn => btn.classList.remove("active"));
            let btnClass = tier === 'all' ? '.btn-all' : (tier === 'platinum' ? '.btn-plat' : (tier === 'gold' ? '.btn-gold' : (tier === 'silver' ? '.btn-silver' : '.btn-bronze')));
            document.querySelector(btnClass).classList.add("active");

            if (tier === 'all') {
                tableBody.classList.remove("card-view");
                tableBody.classList.add("list-view");
                document.getElementById("ladderTable").classList.remove("hide-header");
                systemStatus.innerText = "SOLAR CUP // CUMULATIVE RANKING";
            } else {
                tableBody.classList.remove("list-view");
                tableBody.classList.add("card-view");
                document.getElementById("ladderTable").classList.add("hide-header");
                systemStatus.innerText = "SOLAR CUP // DIVISION VIEW";
            }
            searchPilot();
        }

        function openCard(row) {
            const data = JSON.parse(row.dataset.pilotData);

            document.getElementById("mRank").innerText = data.rank;
            document.getElementById("mName").innerText = data.name;
            document.getElementById("mId").innerText = `ID: ${data.id}`;
            document.getElementById("mScore").innerText = data.score;
            document.getElementById("mTeam").innerText = data.team !== "-" ? data.team : "";

            const historyList = document.getElementById("mHistoryList");
            historyList.innerHTML = ""; 
            
            if (!data.history || data.history.length === 0) {
                historyList.innerHTML = `<div class="log-row" style="color:#666; justify-content:center;">NO DATA</div>`;
            } else {
                data.history.forEach((result, index) => {
                    const cupName = getCupName(index); // ÂèñÂæó "ONE", "TWO"
                    const div = document.createElement("div");
                    div.className = "log-row";
                    
                    // üåü Ê†ºÂºèÔºö ONE : ÁôΩÈáëÁ¥ö ÂÜ†Ëªç
                    div.innerHTML = `
                        <div>
                            <span class="log-cup-name">${cupName} : </span>
                            <span class="log-full-text">${result}</span>
                        </div>
                    `;
                    historyList.appendChild(div);
                });
            }

            const q = evaQuotes[Math.floor(Math.random() * evaQuotes.length)];
            document.getElementById("mQuoteJP").innerText = q.jp;
            document.getElementById("mQuoteCN").innerText = q.cn;
            document.getElementById("mQuoteSource").innerText = `‚Äî‚Äî ${q.source}`;

            let colorVar = "#fff";
            if (data.tierClass === "platinum") colorVar = "var(--color-platinum)";
            else if (data.tierClass === "gold") colorVar = "var(--color-gold)";
            else if (data.tierClass === "silver") colorVar = "var(--color-silver)";
            else if (data.tierClass === "bronze") colorVar = "var(--color-bronze)";
            
            document.getElementById("modalCard").style.borderColor = colorVar;
            document.getElementById("modalCard").style.boxShadow = `0 0 30px ${colorVar}`;
            
            document.body.style.overflow = 'hidden'; 
            document.getElementById("playerModal").style.display = "flex";
        }

        function closeModal() {
            document.body.style.overflow = '';
            document.getElementById("playerModal").style.display = "none";
        }
        window.onclick = function(event) {
            if (event.target == document.getElementById("playerModal")) closeModal();
        }
    </script>
</body>
</html>
